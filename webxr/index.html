<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR-VR Phone - Communication Hub</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none;
        }
        
        .ui-panel {
            position: absolute;
            background: rgba(0,0,20,0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            pointer-events: auto;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        #status-panel {
            top: 20px;
            left: 20px;
            min-width: 280px;
        }
        
        #call-controls {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #user-list {
            top: 20px;
            right: 20px;
            width: 250px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        #video-container {
            bottom: 100px;
            right: 20px;
            display: none;
        }
        
        button {
            padding: 12px 20px;
            margin: 3px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #005a9c;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #333;
            cursor: not-allowed;
            transform: none;
        }
        
        .call-btn {
            background: #00cc44;
            font-size: 16px;
            padding: 15px 25px;
        }
        
        .call-btn:hover {
            background: #00aa33;
        }
        
        .end-call-btn {
            background: #cc0000;
        }
        
        .end-call-btn:hover {
            background: #aa0000;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            border-left: 3px solid #007acc;
        }
        
        .user-online {
            border-left-color: #00cc44;
        }
        
        .user-in-call {
            border-left-color: #cc9900;
            background: rgba(204, 153, 0, 0.2);
        }
        
        video {
            width: 200px;
            height: 150px;
            border-radius: 8px;
            border: 2px solid #007acc;
        }
        
        #local-video {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 90px;
            z-index: 1001;
        }
        
        #chat-panel {
            bottom: 20px;
            left: 20px;
            width: 300px;
            height: 200px;
            display: none;
        }
        
        #chat-messages {
            height: 120px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 5px;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.5);
        }
        
        #chat-input {
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 5px;
        }
        
        .avatar-sphere {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: inline-block;
            margin-right: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .online { background: #00cc44; }
        .calling { background: #cc9900; }
        .offline { background: #666; }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <div id="ui-overlay">
        <!-- Status Panel -->
        <div id="status-panel" class="ui-panel">
            <h3>üåê AR-VR Communication Hub</h3>
            <p><span class="status-indicator online"></span>Status: <span id="status">Connected</span></p>
            <p>üì± Mode: <span id="current-mode">Desktop</span></p>
            <p>üéÆ Room: <span id="room-id">room-001</span></p>
            <p>üë• Active Users: <span id="user-count">1</span></p>
        </div>
        
        <!-- User List -->
        <div id="user-list" class="ui-panel">
            <h4>üë• Connected Users</h4>
            <div id="users-container">
                <div class="user-item user-online">
                    <span>ü§ñ You</span>
                    <button onclick="app.toggleMute()">üé§</button>
                </div>
            </div>
        </div>
        
        <!-- Call Controls -->
        <div id="call-controls" class="ui-panel">
            <button onclick="app.enterAR()" id="ar-btn">ü•Ω Enter AR</button>
            <button onclick="app.enterVR()" id="vr-btn">ü•Ω Enter VR</button>
            <button onclick="app.startCall()" class="call-btn" id="call-btn">üìû Start Call</button>
            <button onclick="app.endCall()" class="end-call-btn" id="end-call-btn" style="display:none">üìû End Call</button>
            <button onclick="app.toggleChat()">üí¨ Chat</button>
            <button onclick="app.shareScreen()">üñ•Ô∏è Share</button>
        </div>
        
        <!-- Video Container -->
        <div id="video-container" class="ui-panel">
            <video id="remote-video" autoplay></video>
        </div>
        
        <!-- Local Video -->
        <video id="local-video" autoplay muted></video>
        
        <!-- Chat Panel -->
        <div id="chat-panel" class="ui-panel">
            <h4>üí¨ Chat</h4>
            <div id="chat-messages"></div>
            <input type="text" id="chat-input" placeholder="Type a message..." onkeypress="app.handleChatInput(event)">
        </div>
    </div>

    <!-- Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script>
        class ARVRCommunicationHub {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.xrSession = null;
                
                // Communication
                this.localStream = null;
                this.remoteStreams = new Map();
                this.peerConnections = new Map();
                this.isInCall = false;
                this.isMuted = false;
                this.chatOpen = false;
                
                // Virtual avatars for users
                this.userAvatars = new Map();
                this.currentRoom = 'room-001';
                
                // Mock users for demo
                this.mockUsers = [
                    { id: 'user1', name: 'Alice', status: 'online', avatar: '#ff6b6b' },
                    { id: 'user2', name: 'Bob', status: 'online', avatar: '#4ecdc4' },
                    { id: 'user3', name: 'Charlie', status: 'calling', avatar: '#45b7d1' }
                ];
                
                this.init();
            }
            
            async init() {
                // Initialize Three.js scene
                this.setupScene();
                
                // Create virtual environment
                this.createVirtualSpace();
                
                // Initialize WebRTC
                this.initializeWebRTC();
                
                // Check XR support
                await this.checkXRSupport();
                
                // Set up mock users
                this.updateUserList();
                
                // Start render loop
                this.renderer.setAnimationLoop(() => this.render());
                
                document.getElementById('status').textContent = 'Ready for Communication!';
            }
            
            setupScene() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                document.getElementById('container').appendChild(this.renderer.domElement);
                
                // Position camera
                this.camera.position.set(0, 1.6, 3);
            }
            
            createVirtualSpace() {
                // Create a virtual room
                const roomGeometry = new THREE.BoxGeometry(10, 6, 10);
                const roomMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x444444,
                    transparent: true,
                    opacity: 0.3,
                    side: THREE.BackSide
                });
                const room = new THREE.Mesh(roomGeometry, roomMaterial);
                room.position.y = 3;
                this.scene.add(room);
                
                // Add floor
                const floorGeometry = new THREE.PlaneGeometry(10, 10);
                const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                floor.receiveShadow = true;
                this.scene.add(floor);
                
                // Add lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                this.scene.add(ambientLight);
                
                const pointLight = new THREE.PointLight(0xffffff, 1, 100);
                pointLight.position.set(0, 5, 0);
                pointLight.castShadow = true;
                this.scene.add(pointLight);
                
                // Create avatar placeholders
                this.createAvatarSpaces();
            }
            
            createAvatarSpaces() {
                const positions = [
                    { x: -2, z: 0 }, { x: 2, z: 0 }, { x: 0, z: -2 }, { x: 0, z: 2 }
                ];
                
                this.mockUsers.forEach((user, index) => {
                    if (index < positions.length) {
                        const avatarGroup = new THREE.Group();
                        
                        // Avatar sphere
                        const avatarGeometry = new THREE.SphereGeometry(0.3, 32, 32);
                        const avatarMaterial = new THREE.MeshLambertMaterial({ color: user.avatar });
                        const avatar = new THREE.Mesh(avatarGeometry, avatarMaterial);
                        avatar.position.y = 1.6;
                        avatar.castShadow = true;
                        
                        // Name tag
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.width = 256;
                        canvas.height = 64;
                        context.fillStyle = 'rgba(0,0,0,0.8)';
                        context.fillRect(0, 0, 256, 64);
                        context.font = '24px Arial';
                        context.fillStyle = 'white';
                        context.textAlign = 'center';
                        context.fillText(user.name, 128, 40);
                        
                        const nameTexture = new THREE.CanvasTexture(canvas);
                        const nameMaterial = new THREE.MeshBasicMaterial({ 
                            map: nameTexture, 
                            transparent: true 
                        });
                        const nameGeometry = new THREE.PlaneGeometry(1, 0.25);
                        const nameTag = new THREE.Mesh(nameGeometry, nameMaterial);
                        nameTag.position.y = 2.2;
                        
                        avatarGroup.add(avatar);
                        avatarGroup.add(nameTag);
                        avatarGroup.position.set(positions[index].x, 0, positions[index].z);
                        
                        this.scene.add(avatarGroup);
                        this.userAvatars.set(user.id, avatarGroup);
                    }
                });
            }
            
            async initializeWebRTC() {
                try {
                    // Get user media (camera/microphone)
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480 },
                        audio: true
                    });
                    
                    const localVideo = document.getElementById('local-video');
                    localVideo.srcObject = this.localStream;
                    localVideo.style.display = 'block';
                    
                    document.getElementById('status').textContent = 'Media ready!';
                } catch (error) {
                    console.error('Failed to get user media:', error);
                    document.getElementById('status').textContent = 'Media access failed';
                }
            }
            
            async checkXRSupport() {
                if ('xr' in navigator) {
                    try {
                        const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
                        const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
                        
                        document.getElementById('ar-btn').disabled = !arSupported;
                        document.getElementById('vr-btn').disabled = !vrSupported;
                        
                        if (arSupported) document.getElementById('current-mode').textContent = 'AR Ready';
                        else if (vrSupported) document.getElementById('current-mode').textContent = 'VR Ready';
                    } catch (error) {
                        console.error('XR support check failed:', error);
                    }
                }
            }
            
            updateUserList() {
                const container = document.getElementById('users-container');
                container.innerHTML = '<div class="user-item user-online"><span>ü§ñ You</span><button onclick="app.toggleMute()">üé§</button></div>';
                
                this.mockUsers.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = `user-item user-${user.status}`;
                    userDiv.innerHTML = `
                        <span>
                            <div class="avatar-sphere" style="background:${user.avatar}"></div>
                            ${user.name}
                        </span>
                        <button onclick="app.callUser('${user.id}')">üìû</button>
                    `;
                    container.appendChild(userDiv);
                });
                
                document.getElementById('user-count').textContent = this.mockUsers.length + 1;
            }
            
            async startCall() {
                if (this.isInCall) return;
                
                this.isInCall = true;
                document.getElementById('call-btn').style.display = 'none';
                document.getElementById('end-call-btn').style.display = 'block';
                document.getElementById('video-container').style.display = 'block';
                document.getElementById('status').textContent = 'In call...';
                
                // Simulate connecting to remote peer
                setTimeout(() => {
                    this.simulateIncomingCall();
                }, 1000);
            }
            
            simulateIncomingCall() {
                // Create a fake remote video stream for demo
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d');
                
                const drawFrame = () => {
                    ctx.fillStyle = '#1a1a2e';
                    ctx.fillRect(0, 0, 640, 480);
                    
                    ctx.fillStyle = '#16213e';
                    ctx.fillRect(100, 100, 440, 280);
                    
                    ctx.fillStyle = '#0f3460';
                    ctx.beginPath();
                    ctx.arc(320, 240, 80, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'white';
                    ctx.font = '24px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Remote User', 320, 350);
                    ctx.fillText(new Date().toLocaleTimeString(), 320, 380);
                    
                    requestAnimationFrame(drawFrame);
                };
                drawFrame();
                
                const stream = canvas.captureStream(30);
                const remoteVideo = document.getElementById('remote-video');
                remoteVideo.srcObject = stream;
            }
            
            endCall() {
                this.isInCall = false;
                document.getElementById('call-btn').style.display = 'block';
                document.getElementById('end-call-btn').style.display = 'none';
                document.getElementById('video-container').style.display = 'none';
                document.getElementById('status').textContent = 'Call ended';
            }
            
            callUser(userId) {
                const user = this.mockUsers.find(u => u.id === userId);
                if (user) {
                    document.getElementById('status').textContent = `Calling ${user.name}...`;
                    setTimeout(() => this.startCall(), 1500);
                }
            }
            
            toggleMute() {
                this.isMuted = !this.isMuted;
                if (this.localStream) {
                    this.localStream.getAudioTracks().forEach(track => {
                        track.enabled = !this.isMuted;
                    });
                }
                document.getElementById('status').textContent = this.isMuted ? 'Muted' : 'Unmuted';
            }
            
            toggleChat() {
                this.chatOpen = !this.chatOpen;
                document.getElementById('chat-panel').style.display = this.chatOpen ? 'block' : 'none';
            }
            
            handleChatInput(event) {
                if (event.key === 'Enter') {
                    const input = document.getElementById('chat-input');
                    const message = input.value.trim();
                    if (message) {
                        this.addChatMessage('You', message);
                        input.value = '';
                        
                        // Simulate response
                        setTimeout(() => {
                            const responses = ['Hello!', 'How are you?', 'Nice to meet you!', 'Great idea!'];
                            const response = responses[Math.floor(Math.random() * responses.length)];
                            this.addChatMessage('Alice', response);
                        }, 1000);
                    }
                }
            }
            
            addChatMessage(sender, message) {
                const messagesDiv = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
            
            shareScreen() {
                document.getElementById('status').textContent = 'Screen sharing started...';
                // Implementation would go here
            }
            
            async enterAR() {
                try {
                    const session = await navigator.xr.requestSession('immersive-ar', {
                        requiredFeatures: ['local-floor']
                    });
                    
                    await this.renderer.xr.setSession(session);
                    this.xrSession = session;
                    document.getElementById('current-mode').textContent = 'AR Active';
                    
                    session.addEventListener('end', () => {
                        this.xrSession = null;
                        document.getElementById('current-mode').textContent = 'Desktop';
                    });
                } catch (error) {
                    console.error('AR failed:', error);
                }
            }
            
            async enterVR() {
                try {
                    const session = await navigator.xr.requestSession('immersive-vr');
                    
                    await this.renderer.xr.setSession(session);
                    this.xrSession = session;
                    document.getElementById('current-mode').textContent = 'VR Active';
                    
                    session.addEventListener('end', () => {
                        this.xrSession = null;
                        document.getElementById('current-mode').textContent = 'Desktop';
                    });
                } catch (error) {
                    console.error('VR failed:', error);
                }
            }
            
            render() {
                // Animate avatars
                this.userAvatars.forEach((avatar, userId) => {
                    const time = Date.now() * 0.001;
                    avatar.children[0].position.y = 1.6 + Math.sin(time + userId.charCodeAt(0)) * 0.1;
                    avatar.children[0].rotation.y += 0.01;
                });
                
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        // Initialize the app
        let app;
        window.addEventListener('load', () => {
            app = new ARVRCommunicationHub();
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (app) {
                app.camera.aspect = window.innerWidth / window.innerHeight;
                app.camera.updateProjectionMatrix();
                app.renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
